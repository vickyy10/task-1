{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Task Management</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        {% if user.is_superadmin or user.is_admin %}
        <a href="{% url 'task_create' %}" class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> Add New Task
        </a>
        {% endif %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <div class="row">
            <div class="col-md-8">
                <form method="get" class="row g-2">
                    <div class="col-md-3">
                        <select name="status" class="form-select">
                            <option value="">All Status</option>
                            <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                            <option value="completed" {% if request.GET.status == 'completed' %}selected{% endif %}>Completed</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" name="due_date" class="form-control" value="{{ request.GET.due_date }}">
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-outline-primary w-100">Filter</button>
                    </div>
                </form>
            </div>
            <div class="col-md-4">
                <form method="get" class="input-group">
                    <input type="text" name="q" class="form-control" placeholder="Search tasks..." value="{{ request.GET.q }}">
                    <button class="btn btn-outline-secondary" type="submit">Search</button>
                </form>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Title</th>
                        <th>Assigned To</th>
                        <th>Due Date</th>

                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{ task.title }}</td>
                        <td>{{ task.assigned_to.username }}</td>
                        <td>{{ task.due_date|date:"M d, Y" }}</td>
                        <td>
                            <span class="badge bg-{% if task.status == 'completed' %}success{% elif task.status == 'in_progress' %}info{% else %}warning{% endif %}">
                                {{ task.get_status_display }}
                            </span>
                        </td>
                        <td>{{ task.created_at|date:"M d, Y" }}</td>
                        <td>
                            {% if user.is_superadmin or user.is_admin %}
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'task_edit' task.id %}" class="btn btn-outline-primary">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteTaskModal" data-task-id="{{ task.id }}" data-task-title="{{ task.title }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            {% else %}
                            {% if task.completion_report is none %}
                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#updateStatusModal" data-task-id="{{ task.id }}">
                                    <i class="bi bi-pencil-square"></i> Update Status
                                </button>
                            </div>
                             {% endif %}
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">No tasks found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card-footer">
        <nav aria-label="Task pagination">
            <ul class="pagination justify-content-center mb-0">
                {% if tasks.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ tasks.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
                </li>
                {% endif %}
                
                {% for num in tasks.paginator.page_range %}
                <li class="page-item {% if tasks.number == num %}active{% endif %}">
                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
                {% endfor %}
                
                {% if tasks.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ tasks.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
</div>

<!-- Task Detail Modal -->
<div class="modal fade" id="taskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Task Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="taskDetails">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal for Users -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Task Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="updateStatusForm" method="post" action="{% url 'task_update_status' %}">
                {% csrf_token %}
                <input type="hidden" name="task_id" id="taskIdInput">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="statusSelect" class="form-label">Status</label>
                        <select class="form-select" id="statusSelect" name="status" required>
                            <option value="">Select Status</option>
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                    <div class="mb-3 completion-fields">
                        <label for="workedHours" class="form-label">Worked Hours</label>
                        <input type="number" class="form-control" id="workedHours" name="worked_hours" min="0" step="0.5">
                        <div class="form-text">Required when marking as completed</div>
                    </div>
                    <div class="mb-3 completion-fields">
                        <label for="completionReport" class="form-label">Completion Report</label>
                        <textarea class="form-control" id="completionReport" name="completion_report" rows="4"></textarea>
                        <div class="form-text">Required when marking as completed</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Task Confirmation Modal -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete task <strong id="deleteTaskTitle"></strong>? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteTaskForm" method="post" action="">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Task</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
    // Task detail modal
    var taskModal = document.getElementById('taskModal')
    taskModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget
        var taskId = button.getAttribute('data-task-id')
        
        fetch('/get-task-data/' + taskId + '/')
            .then(response => response.json())
            .then(data => {
                document.getElementById('taskDetails').innerHTML = `
                    <div class="row mb-3">
                        <div class="col-sm-3 fw-bold">Title:</div>
                        <div class="col-sm-9">${data.title}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3 fw-bold">Description:</div>
                        <div class="col-sm-9">${data.description || 'No description'}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3 fw-bold">Status:</div>
                        <div class="col-sm-9">
                            <span class="badge bg-${data.status === 'completed' ? 'success' : data.status === 'in_progress' ? 'info' : 'warning'}">
                                ${data.status.charAt(0).toUpperCase() + data.status.slice(1).replace('_', ' ')}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3 fw-bold">Due Date:</div>
                        <div class="col-sm-9">${new Date(data.due_date).toLocaleDateString()}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-sm-3 fw-bold">Created:</div>
                        <div class="col-sm-9">${new Date(data.created_at).toLocaleString()}</div>
                    </div>
                    ${data.started_at ? `
                    <div class="row mb-3">
                        <div class="col-sm-3 fw-bold">Started:</div>
                        <div class="col-sm-9">${new Date(data.started_at).toLocaleString()}</div>
                    </div>
                    ` : ''}
                    ${data.completed_at ? `
                    <div class="row mb-3">
                        <div class="col-sm-3 fw-bold">Completed:</div>
                        <div class="col-sm-9">${new Date(data.completed_at).toLocaleString()}</div>
                    </div>
                    ` : ''}
                    ${data.worked_hours ? `
                    <div class="row mb-3">
                        <div class="col-sm-3 fw-bold">Worked Hours:</div>
                        <div class="col-sm-9">${data.worked_hours} hours</div>
                    </div>
                    ` : ''}
                    ${data.completion_report ? `
                    <div class="row mb-3">
                        <div class="col-sm-3 fw-bold">Completion Report:</div>
                        <div class="col-sm-9">${data.completion_report}</div>
                    </div>
                    ` : ''}
                `;
            })
            .catch(error => {
                document.getElementById('taskDetails').innerHTML = `
                    <div class="alert alert-danger">
                        Error loading task details.
                    </div>
                `;
            });
    });
    
    // Update status modal
    var updateStatusModal = document.getElementById('updateStatusModal')
    updateStatusModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget
        var taskId = button.getAttribute('data-task-id')
        document.getElementById('taskIdInput').value = taskId
        
        // Reset form fields when modal is shown
        document.getElementById('statusSelect').value = ''
        document.getElementById('workedHours').value = ''
        document.getElementById('completionReport').value = ''
        
        // Hide completion fields by default
        document.querySelectorAll('.completion-fields').forEach(field => {
            field.style.display = 'none'
        })
    });
    
    // Toggle completion fields based on status selection
    document.getElementById('statusSelect').addEventListener('change', function() {
        const isCompleted = this.value === 'completed'
        document.querySelectorAll('.completion-fields').forEach(field => {
            field.style.display = isCompleted ? 'block' : 'none'
        })
        
        // Toggle required attribute based on status
        document.getElementById('workedHours').required = isCompleted
        document.getElementById('completionReport').required = isCompleted
    });
    
    // Form validation for update status
    document.getElementById('updateStatusForm').addEventListener('submit', function(e) {
        const status = document.getElementById('statusSelect').value;
        const hours = document.getElementById('workedHours').value;
        const report = document.getElementById('completionReport').value;
        
        if (status === 'completed' && (!hours || !report)) {
            e.preventDefault();
            alert('Please fill in both worked hours and completion report when marking a task as completed.');
        }
    });
    
    // Delete task confirmation modal
    var deleteTaskModal = document.getElementById('deleteTaskModal')
    deleteTaskModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget
        var taskId = button.getAttribute('data-task-id')
        var taskTitle = button.getAttribute('data-task-title')
        
        document.getElementById('deleteTaskTitle').textContent = taskTitle
        document.getElementById('deleteTaskForm').action = '/tasks/' + taskId + '/delete/'
    });
</script>
{% endblock %}
{% endblock %}